# HTTP VirtualHost - BitNinja SSL Terminating forwards decrypted HTTP traffic here
# Apache listens on 127.0.0.1:80 (HTTP backend only)
# BitNinja handles SSL termination on 0.0.0.0:443
<VirtualHost 127.0.0.1:80>
    ServerName $DOMAIN
    ServerAdmin $ADMIN_EMAIL
    DocumentRoot $NEXTCLOUD_WEB_DIR

    <Directory $NEXTCLOUD_WEB_DIR/>
        Require all granted
        AllowOverride All
        Options FollowSymLinks MultiViews

        <IfModule mod_dav.c>
            Dav off
        </IfModule>
    </Directory>

    # Trust proxy headers from BitNinja WAF (mod_remoteip required)
    # BitNinja forwards X-Forwarded-For with real client IP
    <IfModule remoteip_module>
        RemoteIPHeader X-Forwarded-For
        RemoteIPInternalProxy 127.0.0.1
    </IfModule>

    # Set HTTPS environment variable for Nextcloud (required for reverse proxy behind SSL terminator)
    # BitNinja forwards X-Forwarded-Proto: https header
    SetEnvIf X-Forwarded-Proto "https" HTTPS=on
    RequestHeader set X-Forwarded-Proto "https" env=HTTPS
    
    # Security Headers (recommended for Nextcloud)
    <IfModule mod_headers.c>
        # HSTS (HTTP Strict Transport Security) - force HTTPS
        Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"
        
        # Prevent clickjacking
        Header always set X-Frame-Options "SAMEORIGIN"
        
        # Prevent MIME-sniffing
        Header always set X-Content-Type-Options "nosniff"
        
        # XSS Protection (legacy browsers)
        Header always set X-XSS-Protection "1; mode=block"
        
        # Referrer Policy
        Header always set Referrer-Policy "no-referrer-when-downgrade"
    </IfModule>

    # Logging with real client IP from proxy (uses %a for RemoteIP)
    ErrorLog ${APACHE_LOG_DIR}/nextcloud-error.log
    CustomLog ${APACHE_LOG_DIR}/nextcloud-access.log combined
</VirtualHost>
