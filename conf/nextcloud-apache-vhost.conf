# HTTP VirtualHost - BitNinja WAF forwards decrypted traffic here
<VirtualHost 127.0.0.1:80>
    ServerName $DOMAIN
    ServerAdmin $ADMIN_EMAIL
    DocumentRoot $NEXTCLOUD_WEB_DIR

    <Directory $NEXTCLOUD_WEB_DIR/>
        Require all granted
        AllowOverride All
        Options FollowSymLinks MultiViews

        <IfModule mod_dav.c>
            Dav off
        </IfModule>
    </Directory>

    # Set HTTPS environment variable for Nextcloud (required for reverse proxy)
    SetEnvIf X-Forwarded-Proto "https" HTTPS=on
    RequestHeader set X-Forwarded-Proto "https" env=HTTPS
    
    # Trust proxy headers from BitNinja WAF (mod_remoteip required)
    RemoteIPHeader X-Forwarded-For
    RemoteIPInternalProxy 127.0.0.1

    # Logging with real client IP from proxy
    ErrorLog ${APACHE_LOG_DIR}/nextcloud-error.log
    CustomLog ${APACHE_LOG_DIR}/nextcloud-access.log combined
</VirtualHost>

# HTTPS VirtualHost - For BitNinja ConfigParser to detect SSL certificates
# Note: Apache doesn't actually listen on 443 - BitNinja SslTerminating does
# This VirtualHost exists ONLY so ConfigParser can find the certificate paths
<VirtualHost 127.0.0.1:443>
    ServerName $DOMAIN
    ServerAdmin $ADMIN_EMAIL
    DocumentRoot $NEXTCLOUD_WEB_DIR

    # SSL Certificate paths for BitNinja ConfigParser
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/$DOMAIN/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/$DOMAIN/privkey.pem

    <Directory $NEXTCLOUD_WEB_DIR/>
        Require all granted
        AllowOverride All
        Options FollowSymLinks MultiViews

        <IfModule mod_dav.c>
            Dav off
        </IfModule>
    </Directory>

    # Trust proxy headers from BitNinja WAF (mod_remoteip required)
    RemoteIPHeader X-Forwarded-For
    RemoteIPInternalProxy 127.0.0.1

    # Logging with real client IP from proxy
    ErrorLog ${APACHE_LOG_DIR}/nextcloud-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/nextcloud-ssl-access.log combined
</VirtualHost>
